<script> 

//https://stackoverflow.com/questions/62537666/publishing-android-gps-location-over-nodejs-server-locally
//https://developers.google.com/maps/documentation/javascript/examples/overlay-popup#maps_overlay_popup-javascript
function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
        zoom: NORMALZOOM,
        center: initLatlng,
        clickableIcons: false,
        restriction: {
            latLngBounds: TAIWAN_BOUNDS,
            strictBounds: false,
        },
        styles: [
            { visibility: "off" },
            { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
            { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
            { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
            { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }], },
            { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }], },
            { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#263c3f" }], },
            { featureType: "poi.park", elementType: "labels.text.fill", stylers: [{ color: "#6b9a76" }], },
            { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }], },
            { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }], },
            { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }], },
            { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }], },
            { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#1f2835" }], },
            { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#f3d19c" }], },
            { featureType: "transit", elementType: "geometry", stylers: [{ color: "#2f3948" }], },
            { featureType: "transit.station", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }], },
            { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }], },
            { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#515c6d" }], },
            { featureType: "water", elementType: "labels.text.stroke", stylers: [{ color: "#17263c" }], },
            { featureType: "poi.business", stylers: [{ visibility: "off" }],  },
            { featureType: "transit", elementType: "labels.icon", stylers: [{ visibility: "off" }], },
        ],
    });
    directionsService   = new google.maps.DirectionsService();
    directionsRenderer  = new google.maps.DirectionsRenderer({
        suppressMarkers: true
    });
    directionsRenderer.setMap(map);

    // user location
    const locationButton = document.createElement("button");
    locationButton.setAttribute('class', 'btn btn-primary');
    locationButton.textContent = "My Location";
    locationButton.classList.add("custom-map-control-button");
    map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(locationButton);
    locationButton.addEventListener("click", () => {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {

                const pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                };
                redirectUrl(pos.lat + "," + pos.lng);
            });
        } else {
            handleError("getCurrentPosition", BROWSER_GEOLOCATION);
        }
    });

    // filter
    const filterButton = document.createElement("button");
    filterButton.setAttribute('class', 'btn btn-primary');
    filterButton.textContent = "Filter";
    map.controls[google.maps.ControlPosition.LEFT_TOP].push(filterButton);
    filterButton.addEventListener("click", () => {
        var markerFilter = document.getElementById('filterDiv') 
        if (markerFilter.style.display=='none') {
            markerFilter.style.display=''
        } 
        else {
            markerFilter.style.display='none'
        }
    });

    google.maps.event.addListener(map, 'click', function(event) {
        removeMarker(CLICKMARKER);
        clearArray(CLICKWINDOWINFO);
        closeOtherWindow();

        placeMarker(event.latLng, [], CLICKMARKER, getMarkerIconSize());

        setUserCenterPos(event.latLng, USERCLICK);
        setCenterIndex(CENTERISBYUSER);

        clickWindowInfoAction(); 
    });

    google.maps.event.addListener(map, 'zoom_changed', function() {
        if (!isMarkerHide && map.getZoom() < NOMARKERZOOM)
            hideMarkers(MARKERS)
        if (isMarkerHide && map.getZoom() > NOMARKERZOOM)
            showMarkers(MARKERS);

        setMarkerIcon(MARKERS, getMarkerIconSize())       
        setMarkerIcon(USERMARKER, getMarkerIconSize()) 
        setMarkerIcon(CLICKMARKER, getMarkerIconSize()) 
    });

    google.maps.event.addListener(map, "center_changed", function() {
        mapCenterPos = {
            lat: map.getCenter().lat(),
            lng: map.getCenter().lng(),
        } 
    });

    google.maps.event.addDomListener(
        document.getElementById("map"), 'load', initMap
    );

    // init location
    var userLatlng = document.getElementById('latLngDiv').dataset.pos
    prepareInitByUserLatlng(userLatlng)
}

function prepareInitByUserLatlng(position) {
    if(position.length != 0) {
        if(!position.includes(",")) {
            redirectUrl("");
            return;
        }
    
        const lat = Number(position.split(",")[0]);
        const lng = Number(position.split(",")[1]);

        if(isNaN(lat) || isNaN(lng)) {
            redirectUrl("");
            return;
        }
        
        const pos = {
            lat: lat,
            lng: lng,
        };

        startServiceByUserLocation(pos)   
    }
}

function startServiceByUserLocation(pos) {
    clearMap()
    aim2Map(CLOSERZOOM, pos);
    setUserCenterPos(pos, USERLOCATION);
    setCenterIndex(CENTERISBYUSER);
    setUserCenterType(USERLOCATION);

    placeMarker(pos, [], USERMARKER, getMarkerIconSize())

    readDataFromFirestore(pos)
}

function readDataFromFirestore(center) {
    const lesserGeopoint = new firebase.firestore.GeoPoint(
        center.lat-NORMALRANGE, 
        center.lng-NORMALRANGE,
    );
    const greaterGeopoint = new firebase.firestore.GeoPoint(
        center.lat+NORMALRANGE, 
        center.lng+NORMALRANGE,
    );
    
    removeOldMarkerList();

    db.collection("PL_Marker_DB")
    .where('location', '>', lesserGeopoint)
    .where('location', '<', greaterGeopoint)
    .get()
    .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
            const pos = {
                lat: doc.data()["location"]._lat,
                lng: doc.data()["location"]._long,
            };
            if (pos.lng > center.lng-NORMALRANGE &&
                pos.lng < center.lng+NORMALRANGE) {
                placeMarker(pos, doc.data(), MARKERS, getMarkerIconSize())
            }
        });
        sortMarker();
        setWindowInfo();
        addMarker2Filter();
        openSameWindowInfo();
    })
    .catch((error) => {
        handleError("readDataFromFirestore", DATABASE_ERROR);
    });
}

function clickWindowInfoAction() {
    var markerWindow = new google.maps.InfoWindow({
        content: getMarkerWindowInfo(clickMarker[0]),
    });
    clickWindowInfo.push(markerWindow);
    clickWindowInfo[0].open({
        anchor: clickMarker[0],
        map,
        shouldFocus: false,
    });

    clickMarker[0].addListener("click", () => {
        closeOtherWindow();
        setUserCenterType(USERCLICK);
            
        clickWindowInfo[0].open({
            anchor: clickMarker[0],
            map,
            shouldFocus: false,
        });
    });
}

function redirectUrl(strAppend) {
    var currentUrl = window.location.href;
    const baseUrl = currentUrl.split(MAPURL)[0];
    window.location.replace(baseUrl + MAPURL + "/" + strAppend);
}
</script>